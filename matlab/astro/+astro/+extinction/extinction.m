function A_3=extinction(Ebv,Family,Filter,R, Args)
    % Given the E_{B-V} and th wavelength or filter name calculate the extinction in magnitudes
    % Input: - E(B-V)
    %        - filter family
    %        - filter
    %        - R_V
    %        * ...,key,val,...
    %        'Model' - 'CCM89' or 'F99' 
    % Output: - extinction [mag]
    % Author: A.M. Krassilchtchikov (Mar 2024)
    % Example: A_550nm = astro.extinction.extinction(0.09,0.55);
    %          A_U     = astro.extinction.extinction(0.13,'Johnson','U');
    %          A_250nm_ccm = astro.extinction.extinction(0.2,0.25,'[]','Model','CCM89');
    %          A_250nm_f99 = astro.extinction.extinction(0.2,0.25,'[]','Model','F99');
    arguments
        Ebv
        Family  
        Filter
        R           = 3.08;
        Args.Model = 'CCM89'; % 'F99'
    end
    
    if strcmpi(Args.Model,'ccm89')   % Cardelli, Clayton, Mathis (1989)
        A_3=CCM89(Ebv,Family,Filter,R); 
    elseif strcmpi(Args.Model,'f99') % Fitzpatrick (1999)  
        fprintf('Warning: the law of Fitzpatrick is coded for R_V = 3.1 only!\n');
        if (isnumeric(Family))
            L = Family;
        else           
            F = AstFilter.get(Family,Filter);
            L = [F.eff_wl]./10000;
        end        
        X = 1./L;
        R1  = F99(X);
        A_3 = Ebv .* (R + R1);
    else
        error('Illegal model');
    end

end

function A_3=CCM89(Ebv,Family,Filter,R)
% Extinction in band from E_{B-V}
% Package: astro.spec
% Description: Given the E_{B-V} and the wavelength or filter name calculate
%              the extinction in magnitude.
%              The program works in the 0.1-2 micron range.
%              The program is using the Cardelli, Clayton, Mathis (1989)
%              model.
%              See also old version: optical_extinction.m.
% Input  : - E_{B-V} [mag]
%          - Filter effective wavelength [microns] or filter family name
%            (e.g., 'SDSS'). See get_filter.m for details.
%          - Filter name (e.g., 'r').
%          - R (scalar) Av/E(B-V), default value is 3.08.
% Output : - Extinction [mag]
% Tested : MATLAB 5.1
%     By : Eran O. Ofek                    Feb 2001
%    URL : http://weizmann.ac.il/home/eofek/matlab/
% See also: optical_extinction.m
% Reference : Cardelli, Clayton, Mathis 1989 ApJ 345, 245
% Example: % to calculate The extinction in 'U' band given E(B-V)=0.1
%          A_U = astro.extinction.extinction(0.1,'Johnson','U')
% Reliable: 1
%--------------------------------------------------------------------------
if (nargin==2)
   Filter = [];
   R     = 3.08;
elseif (nargin==3)
   R     = 3.08;
elseif (nargin==4)
   % do nothing
else
   error('Illegal number of input arguments');
end

if (isnumeric(Family))
   L = Family;
else
   %F = get_astfilter(Family,Filter);
   F = AstFilter.get(Family,Filter);
   L = [F.eff_wl]./10000; 
end


X = 1./L;

N = length(L);
if (length(R)==1)
   R = R.*ones(N,1);
end


A = zeros(size(X)).*NaN;
B = zeros(size(X)).*NaN;

% 0.3-1.1
I = find(X>=0.3 & X<1.1);
A(I) =  0.574.*X(I).^1.61;
B(I) = -0.527.*X(I).^1.61;

% 1.1-3.3
I = find(X>=1.1 & X<3.3);
Y = X(I) - 1.82;
A(I) = 1 + 0.17699.*Y - 0.50447.*Y.^2 - 0.02427.*Y.^3 + 0.72085.*Y.^4 + 0.01979.*Y.^5 - 0.77530.*Y.^6 + 0.32999.*Y.^7;
B(I) = 1.41338.*Y + 2.28305.*Y.^2 + 1.07233.*Y.^3 - 5.38434.*Y.^4 - 0.62251.*Y.^5 + 5.30260.*Y.^6 - 2.09002.*Y.^7;

% 5.9-8
I = find(X>=5.9 & X<8);
Fa = -0.04473.*(X(I)-5.9).^2 - 0.009779.*(X(I)-5.9).^3;
Fb = 0.2130.*(X(I)-5.9).^2 + 0.1207.*(X(I)-5.9).^3;
A(I)  =  1.752 - 0.316.*X(I) - 0.104./((X(I)-4.67).^2 + 0.341) + Fa;
B(I)  = -3.090 + 1.825.*X(I) + 1.206./((X(I)-4.62).^2 + 0.263) + Fb;

% 3.3-5.9
I = find(X>=3.3 & X<5.9);
A(I) =  1.752 - 0.316.*X(I) - 0.104./((X(I)-4.67).^2 + 0.341);
B(I) = -3.090 + 1.825.*X(I) + 1.206./((X(I)-4.62).^2 + 0.263);

% 8-10
I = find(X>=8 & X<=10);
A(I) = -1.073 - 0.628.*(X(I)-8) + 0.137.*(X(I)-8).^2 - 0.070.*(X(I)-8).^3;
B(I) = 13.670 + 4.257.*(X(I)-8) - 0.420.*(X(I)-8).^2 + 0.374.*(X(I)-8).^3;


A_L3 = A + B./R;



Const = A_L3./Ebv;
%sprintf('\n The relation constant is : A(3)=E(1-2) x %4.2f \n', Const)

%Factor = (2.512.^E - 1)./(2.512.^E_L12 - 1);
%A_3    = 2.5.*log10(((2.512.^A_L3 - 1).*Factor) + 1);
A_3    = Ebv.*Const;
A_3    = A_L3.*R.*Ebv;

end

function Reff = F99(X) % the reddening law for R_V = 3.1 from Fig. 1 of Fitzpatrick (1999)
                       % X is the array of 1/wavelength in [micron(-1)]    
ReddeningLaw = [                 
0.0297214759082, -3.07779703414;
0.0601977181917, -3.07792962824;
0.100819108509, -3.04330047096;
0.151606045951, -3.02611848642;
0.212538131426, -2.97417475051;
0.28362896433, -2.92227521264;
0.314098406916, -2.90500483203;
0.359785571553, -2.83559182438;
0.405486335584, -2.80098476613;
0.446107725901, -2.76635560886;
0.501960437663, -2.71438977394;
0.557806349727, -2.64502096432;
0.603507113758, -2.61041390606;
0.639042330664, -2.55835967508;
0.699967616443, -2.48901296447;
0.771031250558, -2.36750152781;
0.842094884673, -2.24599009114;
0.923303666822, -2.08971690311;
0.99436050124, -1.95080249175;
1.06034476164, -1.82926895607;
1.11615667522, -1.67288527296;
1.1770683616, -1.56873261296;
1.23796644859, -1.42977400357;
1.29379876127, -1.32559924455;
1.36483519659, -1.1344759091;
1.41558813555, -1.03027905107;
1.45111655276, -0.960821845387;
1.51200104035, -0.787057286598;
1.5576610062, -0.648032380157;
1.61350691827, -0.578663570538;
1.64902173608, -0.474400415461;
1.69977467504, -0.370203557432;
1.77589728378, -0.196505295689;
1.82157084902, -0.0922863386436;
1.86723761456, 0.0293355930993;
1.96365051937, 0.27255735757;
2.02961438068, 0.446299817343;
2.09051246767, 0.585258426737;
2.17172124982, 0.741531614767;
2.24785745795, 0.880423927114;
2.33922498753, 1.03665291711;
2.41536799536, 1.15814225476;
2.50166975061, 1.27958739438;
2.5981234536, 1.41839131067;
2.71488785175, 1.57450980559;
2.81133475504, 1.73071669657;
2.91286783174, 1.86949851384;
2.99916958699, 1.99094365346;
3.04486355133, 2.04295368641;
3.09054391627, 2.12976966876;
3.14131725432, 2.1817576027;
3.2022289407, 2.2859102627;
3.28853069596, 2.40735540232;
3.32405231347, 2.4942155827;
3.37990502523, 2.54618141762;
3.42559218987, 2.61559442527;
3.48142450254, 2.71976918428;
3.52710486748, 2.80658516663;
3.58294397985, 2.89335695095;
3.64383526714, 3.04971853504;
3.730123423, 3.20596962405;
3.80625283144, 3.3622649111;
3.87728246707, 3.57079122125;
3.93816015497, 3.76195875474;
4.00919659029, 3.95308209019;
4.08020582683, 4.21381732444;
4.14104951624, 4.49199973141;
4.19173445823, 4.77022633642;
4.25766432105, 5.03098366968;
4.30326988933, 5.3092323737;
4.34381648298, 5.53529425264;
4.38944925004, 5.74393105787;
4.44522716513, 5.98732961447;
4.51115022826, 6.26548992242;
4.57713448866, 6.3870234581;
4.62283525269, 6.42163051636;
4.6634770421, 6.40405074954;
4.70414603029, 6.31685908393;
4.74481501849, 6.22966741832;
4.78040463297, 6.14249785172;
4.82108042087, 6.03790321141;
4.86178340755, 5.86369667231;
4.90247279484, 5.72429608261;
4.94824155584, 5.58487339389;
4.99401031684, 5.44545070517;
5.04486525125, 5.28860294274;
5.09062721256, 5.16658322872;
5.14654792129, 5.04451931666;
5.20754800374, 4.9224333056;
5.25837573936, 4.83519744195;
5.30920347499, 4.74796157831;
5.36001081152, 4.71293463876;
5.40574557403, 4.66052682353;
5.48702915285, 4.62536728989;
5.55308141022, 4.57287107859;
5.62421304131, 4.52035276828;
5.71564176816, 4.51995498601;
5.79690494788, 4.53700437646;
5.88326110072, 4.51922571849;
5.95435873332, 4.55372228167;
6.03562871274, 4.55336869742;
6.1270438402, 4.58777686454;
6.22353154167, 4.63956590734;
6.33017799057, 4.69131075211;
6.39112367544, 4.70844853862;
6.45712833493, 4.77777315021;
6.50790847268, 4.81235810945;
6.57900610528, 4.84685467262;
6.66532145993, 4.93349386285;
6.75164361428, 5.00273007838;
6.83288639491, 5.07198839292;
6.90395682872, 5.17609685489;
6.98012023564, 5.24537726844;
7.05627004317, 5.3494636314;
7.15273734555, 5.45346159829;
7.24920464793, 5.55745956518;
7.32534085606, 5.69635187752;
7.42180135875, 5.81775281911;
7.49288539196, 5.88705533168;
7.56903519948, 5.99114169464;
7.65024398163, 6.14741488267;
7.73653893719, 6.28626299698;
7.82282709305, 6.442514086;
7.9040358752, 6.59878727403;
7.98017208333, 6.73767958637;
8.05630149177, 6.89397487342;
8.09691608239, 6.94600700539;
8.14766902135, 7.05020386342;
8.18828361197, 7.10223599539;
8.24411592464, 7.2064107544;
8.27962394275, 7.32807688417;
8.33037688171, 7.4322737422;
8.38113662036, 7.51906762554;
8.43696213334, 7.64064535925;
8.51308474207, 7.81434362099;
8.59426632544, 8.04022870781;
8.65009863811, 8.14440346683;
8.69577900305, 8.23121944917;
];

Reff = interp1(ReddeningLaw(:,1),ReddeningLaw(:,2),X);

end

